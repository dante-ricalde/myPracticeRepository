00000000: 2f 2a 2a 0d 0a 2a 20 0d 0a 2a 2f 0d 0a 76 61 72 /**..* ..*/..var
00000010: 20 5f 63 61 6e 4c 6f 67 20 3d 20 74 72 75 65 3b _canLog = true;
00000020: 0d 0a 0d 0a 28 66 75 6e 63 74 69 6f 6e 20 28 24 ....(function ($
00000030: 29 20 7b 0d 0a 09 0d 0a 09 22 75 73 65 20 73 74 ) {......"use st
00000040: 72 69 63 74 22 3b 0d 0a 09 0d 0a 09 69 66 20 28 rict";......if (
00000050: 21 77 69 6e 64 6f 77 2e 63 68 61 74 29 20 7b 0d !window.chat) {.
00000060: 0a 09 09 77 69 6e 64 6f 77 2e 63 68 61 74 20 3d ...window.chat =
00000070: 20 7b 7d 3b 0d 0a 09 7d 0d 0a 09 0d 0a 09 69 66 {};...}......if
00000080: 20 28 21 63 68 61 74 2e 76 69 65 77 29 20 7b 0d (!chat.view) {.
00000090: 0a 09 09 63 68 61 74 2e 76 69 65 77 20 3d 20 7b ...chat.view = {
000000a0: 7d 3b 0d 0a 09 7d 0d 0a 09 0d 0a 09 69 66 20 28 };...}......if (
000000b0: 21 63 68 61 74 2e 76 69 65 77 2e 55 73 65 72 56 !chat.view.UserV
000000c0: 69 65 77 29 20 7b 0d 0a 09 09 63 68 61 74 2e 76 iew) {....chat.v
000000d0: 69 65 77 2e 55 73 65 72 56 69 65 77 20 3d 20 66 iew.UserView = f
000000e0: 75 6e 63 74 69 6f 6e 20 28 6f 70 74 69 6f 6e 73 unction (options
000000f0: 2c 20 63 6f 6e 74 61 69 6e 65 72 2c 20 63 6f 6e , container, con
00000100: 74 61 69 6e 65 72 53 65 74 74 69 6e 67 73 2c 20 tainerSettings,
00000110: 75 73 65 72 4c 69 2c 20 6d 65 73 73 61 67 65 52 userLi, messageR
00000120: 65 73 6f 6c 76 65 72 29 20 7b 0d 0a 09 09 09 63 esolver) {.....c
00000130: 6f 6e 73 6f 6c 65 2e 6c 6f 67 28 22 55 73 65 72 onsole.log("User
00000140: 20 56 69 65 77 20 63 72 65 61 74 69 6f 6e 20 69 View creation i
00000150: 6e 76 6f 6b 65 64 22 29 3b 0d 0a 09 09 09 76 61 nvoked");.....va
00000160: 72 20 74 68 61 74 20 3d 20 74 68 69 73 3b 0d 0a r that = this;..
00000170: 09 09 09 74 68 69 73 2e 24 63 6f 6e 74 61 69 6e ...this.$contain
00000180: 65 72 53 65 74 74 69 6e 67 73 20 3d 20 63 6f 6e erSettings = con
00000190: 74 61 69 6e 65 72 53 65 74 74 69 6e 67 73 3b 0d tainerSettings;.
000001a0: 0a 09 09 09 24 28 77 69 6e 64 6f 77 29 2e 62 6c ....$(window).bl
000001b0: 75 72 28 66 75 6e 63 74 69 6f 6e 28 29 7b 0d 0a ur(function(){..
000001c0: 09 09 09 09 63 6f 6e 73 6f 6c 65 2e 6c 6f 67 28 ....console.log(
000001d0: 27 79 6f 75 20 68 61 76 65 20 6c 6f 73 74 20 74 'you have lost t
000001e0: 68 65 20 66 6f 63 75 73 2e 27 29 3b 0d 0a 20 20 he focus.');..
000001f0: 20 20 20 20 20 20 20 20 20 20 20 20 20 20 74 68 th
00000200: 61 74 2e 24 63 6f 6e 74 61 69 6e 65 72 53 65 74 at.$containerSet
00000210: 74 69 6e 67 73 2e 68 61 73 46 6f 63 75 73 20 3d tings.hasFocus =
00000220: 20 66 61 6c 73 65 3b 0d 0a 09 09 09 7d 29 3b 0d false;.....});.
00000230: 0a 09 09 09 24 28 77 69 6e 64 6f 77 29 2e 66 6f ....$(window).fo
00000240: 63 75 73 28 66 75 6e 63 74 69 6f 6e 28 29 7b 0d cus(function(){.
00000250: 0a 09 09 09 09 63 6f 6e 73 6f 6c 65 2e 6c 6f 67 .....console.log
00000260: 28 27 79 6f 75 20 68 61 76 65 20 72 65 63 6f 76 ('you have recov
00000270: 65 72 65 64 20 74 68 65 20 66 6f 63 75 73 2e 27 ered the focus.'
00000280: 29 3b 0d 0a 20 20 20 20 20 20 20 20 20 20 20 20 );..
00000290: 20 20 20 20 74 68 61 74 2e 24 63 6f 6e 74 61 69 that.$contai
000002a0: 6e 65 72 53 65 74 74 69 6e 67 73 2e 68 61 73 46 nerSettings.hasF
000002b0: 6f 63 75 73 20 3d 20 74 72 75 65 3b 0d 0a 20 20 ocus = true;..
000002c0: 20 20 20 20 20 20 20 20 20 20 20 20 20 20 69 66 if
000002d0: 20 28 74 68 61 74 2e 69 73 55 73 65 72 57 69 6e (that.isUserWin
000002e0: 64 6f 77 4f 70 65 6e 28 29 29 20 7b 0d 0a 20 20 dowOpen()) {..
000002f0: 20 20 20 20 20 20 20 20 20 20 20 20 20 20 09 74 .t
00000300: 68 61 74 2e 6c 6f 6f 6b 46 6f 72 43 6f 6e 66 69 hat.lookForConfi
00000310: 72 6d 69 6e 67 52 65 61 64 4d 65 73 73 61 67 65 rmingReadMessage
00000320: 73 28 29 3b 0d 0a 20 20 20 20 20 20 20 20 20 20 s();..
00000330: 20 20 20 20 20 20 7d 0d 0a 09 09 09 7d 29 3b 0d }.....});.
00000340: 0a 09 20 20 20 20 09 74 68 69 73 2e 24 75 73 65 .. .this.$use
00000350: 72 57 69 6e 64 6f 77 20 3d 20 24 28 22 3c 64 69 rWindow = $("<di
00000360: 76 20 69 64 20 3d 20 27 77 69 6e 64 6f 77 22 20 v id = 'window"
00000370: 2b 20 24 28 63 6f 6e 74 61 69 6e 65 72 29 2e 74 + $(container).t
00000380: 65 78 74 28 29 20 2b 20 22 27 20 63 6c 61 73 73 ext() + "' class
00000390: 3d 27 63 68 61 74 2d 77 69 6e 64 6f 77 27 3e 22 ='chat-window'>"
000003a0: 29 3b 0d 0a 09 20 20 20 20 09 74 68 69 73 2e 24 );... .this.$
000003b0: 75 73 65 72 4c 69 20 3d 20 75 73 65 72 4c 69 3b userLi = userLi;
000003c0: 09 20 20 20 20 09 0d 0a 09 20 20 20 20 09 74 68 . .... .th
000003d0: 69 73 2e 6f 70 74 69 6f 6e 73 20 3d 20 24 2e 65 is.options = $.e
000003e0: 78 74 65 6e 64 28 7b 0d 0a 09 20 20 20 20 09 09 xtend({... ..
000003f0: 6c 61 6e 67 75 61 67 65 3a 20 22 65 6e 22 2c 0d language: "en",.
00000400: 0a 09 20 20 20 20 09 09 64 69 73 70 6c 61 79 3a .. ..display:
00000410: 20 74 72 75 65 2c 0d 0a 09 20 20 20 20 09 09 6d true,... ..m
00000420: 65 73 73 61 67 65 52 65 73 6f 6c 76 65 72 3a 20 essageResolver:
00000430: 66 75 6e 63 74 69 6f 6e 20 28 29 20 7b 7d 2c 0d function () {},.
00000440: 0a 09 20 20 20 20 09 09 77 69 64 74 68 3a 20 35 .. ..width: 5
00000450: 30 30 2c 0d 0a 09 09 09 09 68 65 69 67 68 74 3a 00,......height:
00000460: 20 34 30 30 2c 0d 0a 09 09 09 09 70 6f 73 69 74 400,......posit
00000470: 69 6f 6e 3a 20 7b 78 3a 20 27 63 65 6e 74 65 72 ion: {x: 'center
00000480: 27 2c 20 79 3a 20 27 63 65 6e 74 65 72 27 7d 2c ', y: 'center'},
00000490: 0d 0a 09 09 09 09 74 69 74 6c 65 3a 20 22 22 2c ......title: "",
000004a0: 0d 0a 09 09 09 09 62 75 74 74 6f 6e 54 65 78 74 ......buttonText
000004b0: 3a 20 22 22 0d 0a 09 20 20 20 20 09 7d 2c 20 6f : ""... .}, o
000004c0: 70 74 69 6f 6e 73 20 7c 7c 20 7b 7d 29 3b 0d 0a ptions || {});..
000004d0: 09 20 20 20 20 09 74 68 69 73 2e 24 6d 65 73 73 . .this.$mess
000004e0: 61 67 65 73 20 3d 20 24 28 22 3c 64 69 76 20 63 ages = $("<div c
000004f0: 6c 61 73 73 3d 27 63 68 61 74 2d 74 65 78 74 2d lass='chat-text-
00000500: 6d 65 73 73 61 67 65 73 27 3e 22 29 3b 0d 0a 09 messages'>");...
00000510: 20 20 20 20 09 74 68 69 73 2e 71 75 65 75 65 4d .this.queueM
00000520: 65 73 73 61 67 65 73 20 3d 20 5b 5d 3b 0d 0a 09 essages = [];...
00000530: 20 20 20 20 09 74 68 69 73 2e 24 75 73 65 72 57 .this.$userW
00000540: 69 6e 64 6f 77 2e 61 70 70 65 6e 64 28 74 68 69 indow.append(thi
00000550: 73 2e 24 6d 65 73 73 61 67 65 73 29 3b 0d 0a 09 s.$messages);...
00000560: 20 20 20 20 09 74 68 69 73 2e 24 6d 65 73 73 61 .this.$messa
00000570: 67 65 49 6e 70 75 74 20 3d 20 24 28 22 3c 69 6e geInput = $("<in
00000580: 70 75 74 3e 22 29 3b 0d 0a 09 20 20 20 20 09 74 put>");... .t
00000590: 68 69 73 2e 24 75 73 65 72 57 69 6e 64 6f 77 2e his.$userWindow.
000005a0: 61 70 70 65 6e 64 28 74 68 69 73 2e 24 6d 65 73 append(this.$mes
000005b0: 73 61 67 65 49 6e 70 75 74 29 3b 0d 0a 09 20 20 sageInput);...
000005c0: 20 20 09 74 68 69 73 2e 24 62 75 74 74 6f 6e 53 .this.$buttonS
000005d0: 75 62 6d 69 74 20 3d 20 24 28 22 3c 62 75 74 74 ubmit = $("<butt
000005e0: 6f 6e 3e 22 29 3b 0d 0a 09 20 20 20 20 09 76 61 on>");... .va
000005f0: 72 20 62 75 74 74 6f 6e 54 65 78 74 20 3d 20 28 r buttonText = (
00000600: 74 68 61 74 2e 6f 70 74 69 6f 6e 73 2e 62 75 74 that.options.but
00000610: 74 6f 6e 54 65 78 74 20 3f 20 74 68 61 74 2e 6f tonText ? that.o
00000620: 70 74 69 6f 6e 73 2e 62 75 74 74 6f 6e 54 65 78 ptions.buttonTex
00000630: 74 20 3a 20 6d 65 73 73 61 67 65 52 65 73 6f 6c t : messageResol
00000640: 76 65 72 2e 67 65 74 4d 65 73 73 61 67 65 28 22 ver.getMessage("
00000650: 63 68 61 74 2e 77 69 6e 64 6f 77 2e 62 75 74 74 chat.window.butt
00000660: 6f 6e 2e 64 65 66 61 75 6c 74 54 65 78 74 22 29 on.defaultText")
00000670: 29 3b 0d 0a 09 20 20 20 20 09 74 68 69 73 2e 24 );... .this.$
00000680: 62 75 74 74 6f 6e 53 75 62 6d 69 74 2e 74 65 78 buttonSubmit.tex
00000690: 74 28 62 75 74 74 6f 6e 54 65 78 74 29 3b 0d 0a t(buttonText);..
000006a0: 09 20 20 20 20 09 74 68 69 73 2e 24 75 73 65 72 . .this.$user
000006b0: 57 69 6e 64 6f 77 2e 61 70 70 65 6e 64 28 74 68 Window.append(th
000006c0: 69 73 2e 24 62 75 74 74 6f 6e 53 75 62 6d 69 74 is.$buttonSubmit
000006d0: 29 3b 09 20 20 20 20 09 0d 0a 09 20 20 20 20 09 );. .... .
000006e0: 74 68 69 73 2e 73 74 6f 6d 70 43 6c 69 65 6e 74 this.stompClient
000006f0: 44 65 73 74 69 6e 61 74 69 6f 6e 3d 63 6f 6e 74 Destination=cont
00000700: 61 69 6e 65 72 2e 73 74 6f 6d 70 43 6c 69 65 6e ainer.stompClien
00000710: 74 44 65 73 74 69 6e 61 74 69 6f 6e 3b 0d 0a 09 tDestination;...
00000720: 20 20 20 20 20 20 20 20 0d 0a 09 20 20 20 20 20 ...
00000730: 20 20 20 69 66 20 28 74 68 69 73 2e 6f 70 74 69 if (this.opti
00000740: 6f 6e 73 2e 64 69 73 70 6c 61 79 29 20 7b 0d 0a ons.display) {..
00000750: 09 09 2f 2f 09 09 09 73 74 6f 6d 70 43 6c 69 65 ..//...stompClie
00000760: 6e 74 44 65 73 74 69 6e 61 74 69 6f 6e 2e 73 75 ntDestination.su
00000770: 62 73 63 72 69 62 65 28 27 2f 61 70 70 43 68 61 bscribe('/appCha
00000780: 74 52 65 6c 61 79 2f 63 68 61 74 2f 72 65 63 65 tRelay/chat/rece
00000790: 69 76 65 4d 65 73 73 61 67 65 27 2c 20 66 75 6e iveMessage', fun
000007a0: 63 74 69 6f 6e 20 28 66 72 61 6d 65 29 20 7b 0d ction (frame) {.
000007b0: 0a 09 20 20 20 20 20 20 20 20 09 74 68 61 74 2e .. .that.
000007c0: 73 74 6f 6d 70 43 6c 69 65 6e 74 44 65 73 74 69 stompClientDesti
000007d0: 6e 61 74 69 6f 6e 2e 64 6f 6e 65 28 66 75 6e 63 nation.done(func
000007e0: 74 69 6f 6e 20 28 29 20 7b 0d 0a 09 20 20 20 20 tion () {...
000007f0: 20 20 20 20 09 09 2f 2f 20 57 65 20 6d 61 6b 65 ..// We make
00000800: 20 61 20 73 75 62 73 63 72 69 62 65 20 74 6f 20 a subscribe to
00000810: 6c 69 73 74 65 6e 20 66 6f 72 20 6d 65 73 73 61 listen for messa
00000820: 67 65 73 20 73 65 6e 74 20 66 72 6f 6d 20 61 20 ges sent from a
00000830: 63 6f 6e 74 61 63 74 20 28 6f 72 20 66 72 6f 6d contact (or from
00000840: 20 61 20 73 65 6e 64 65 72 29 0d 0a 09 20 20 20 a sender)...
00000850: 20 20 20 20 20 09 09 74 68 61 74 2e 73 74 6f 6d ..that.stom
00000860: 70 43 6c 69 65 6e 74 44 65 73 74 69 6e 61 74 69 pClientDestinati
00000870: 6f 6e 2e 73 75 62 73 63 72 69 62 65 28 27 2f 65 on.subscribe('/e
00000880: 78 63 68 61 6e 67 65 2f 63 68 61 74 44 69 72 65 xchange/chatDire
00000890: 63 74 45 78 63 68 61 6e 67 65 2f 6d 65 73 73 61 ctExchange/messa
000008a0: 67 65 73 2d 27 20 2b 20 74 68 61 74 2e 24 63 6f ges-' + that.$co
000008b0: 6e 74 61 69 6e 65 72 53 65 74 74 69 6e 67 73 2e ntainerSettings.
000008c0: 70 61 72 61 6d 73 2e 75 73 65 72 4e 61 6d 65 20 params.userName
000008d0: 2b 20 27 2d 27 20 2b 20 74 68 61 74 2e 24 75 73 + '-' + that.$us
000008e0: 65 72 4c 69 2e 74 65 78 74 28 29 2c 20 66 75 6e erLi.text(), fun
000008f0: 63 74 69 6f 6e 20 28 66 72 61 6d 65 29 20 7b 09 ction (frame) {.
00000900: 09 09 09 09 0d 0a 09 09 09 09 09 09 76 61 72 20 ............var
00000910: 24 70 20 3d 20 24 28 22 3c 70 20 63 6c 61 73 73 $p = $("<p class
00000920: 3d 27 63 68 61 74 2d 72 65 63 65 69 76 65 64 2d ='chat-received-
00000930: 6d 65 73 73 61 67 65 27 3e 22 29 3b 0d 0a 09 09 message'>");....
00000940: 09 09 09 09 76 61 72 20 6d 65 73 73 61 67 65 20 ....var message
00000950: 3d 20 4a 53 4f 4e 2e 70 61 72 73 65 28 66 72 61 = JSON.parse(fra
00000960: 6d 65 2e 62 6f 64 79 29 3b 0d 0a 09 09 09 09 09 me.body);.......
00000970: 09 74 68 61 74 2e 61 64 64 4d 65 73 73 61 67 65 .that.addMessage
00000980: 28 6d 65 73 73 61 67 65 2c 20 6d 65 73 73 61 67 (message, messag
00000990: 65 2e 73 65 6e 64 65 72 20 21 3d 3d 20 74 68 61 e.sender !== tha
000009a0: 74 2e 24 63 6f 6e 74 61 69 6e 65 72 53 65 74 74 t.$containerSett
000009b0: 69 6e 67 73 2e 70 61 72 61 6d 73 2e 75 73 65 72 ings.params.user
000009c0: 4e 61 6d 65 29 3b 0d 0a 09 09 09 09 09 09 74 68 Name);........th
000009d0: 61 74 2e 5f 69 6e 69 74 28 29 3b 0d 0a 2f 2f 09 at._init();..//.
000009e0: 09 09 09 09 09 69 66 20 28 21 74 68 61 74 2e 24 .....if (!that.$
000009f0: 75 73 65 72 57 69 6e 64 6f 77 2e 64 69 61 6c 6f userWindow.dialo
00000a00: 67 28 22 69 73 4f 70 65 6e 22 29 29 20 7b 0d 0a g("isOpen")) {..
00000a10: 2f 2f 09 09 09 09 09 09 09 74 68 61 74 2e 73 68 //.......that.sh
00000a20: 6f 77 28 74 68 61 74 2e 6f 70 74 69 6f 6e 73 2e ow(that.options.
00000a30: 70 6f 73 69 74 69 6f 6e 2e 78 2c 20 74 68 61 74 position.x, that
00000a40: 2e 6f 70 74 69 6f 6e 73 2e 70 6f 73 69 74 69 6f .options.positio
00000a50: 6e 2e 79 29 3b 0d 0a 2f 2f 09 09 09 09 09 09 7d n.y);..//......}
00000a60: 2f 2f 20 49 66 20 74 68 65 20 6d 65 73 73 61 67 // If the messag
00000a70: 65 20 69 73 20 72 65 63 65 69 76 65 64 20 66 72 e is received fr
00000a80: 6f 6d 20 74 68 65 20 73 65 6e 64 65 72 20 61 6e om the sender an
00000a90: 64 20 69 74 27 73 20 6e 6f 74 20 61 20 63 6f 6e d it's not a con
00000aa0: 66 69 72 6d 61 74 69 6f 6e 20 74 68 61 74 20 69 firmation that i
00000ab0: 74 20 68 61 73 20 62 65 65 6e 20 72 65 63 65 69 t has been recei
00000ac0: 76 65 64 20 62 79 20 74 68 65 20 73 65 72 76 65 ved by the serve
00000ad0: 72 2e 0d 0a 09 09 09 09 09 09 2f 2f 20 61 6e 64 r.........// and
00000ae0: 20 61 6c 73 6f 20 69 74 27 73 20 6e 6f 74 20 61 also it's not a
00000af0: 20 63 6f 6e 66 69 72 6d 61 74 69 6f 6e 20 74 68 confirmation th
00000b00: 61 74 20 74 68 65 20 63 6c 69 65 6e 74 20 68 61 at the client ha
00000b10: 73 20 72 65 63 65 69 76 65 64 20 74 68 65 20 6d s received the m
00000b20: 65 73 73 61 67 65 0d 0a 09 09 09 09 09 09 69 66 essage........if
00000b30: 20 28 21 6d 65 73 73 61 67 65 2e 72 65 63 65 69 (!message.recei
00000b40: 76 65 64 42 79 53 65 72 76 65 72 20 26 26 20 21 vedByServer && !
00000b50: 6d 65 73 73 61 67 65 2e 72 65 63 65 69 76 65 64 message.received
00000b60: 42 79 43 6c 69 65 6e 74 29 20 7b 0d 0a 09 09 09 ByClient) {.....
00000b70: 09 09 09 09 74 68 61 74 2e 63 6f 6e 66 69 72 6d ....that.confirm
00000b80: 52 65 63 65 69 76 65 64 4d 65 73 73 61 67 65 28 ReceivedMessage(
00000b90: 6d 65 73 73 61 67 65 29 3b 0d 0a 09 09 09 09 09 message);.......
00000ba0: 09 7d 0d 0a 09 09 09 09 09 09 2f 2f 66 72 61 6d .}........//fram
00000bb0: 65 2e 61 63 6b 28 7b 27 69 64 27 3a 6d 65 73 73 e.ack({'id':mess
00000bc0: 61 67 65 2e 69 64 7d 29 3b 0d 0a 09 09 09 09 09 age.id});.......
00000bd0: 7d 2c 20 2f 2a 7b 61 63 6b 3a 20 27 63 6c 69 65 }, /*{ack: 'clie
00000be0: 6e 74 2d 69 6e 64 69 76 69 64 75 61 6c 27 7d 2a nt-individual'}*
00000bf0: 2f 20 7b 7d 29 3b 0d 0a 09 20 20 20 20 20 20 20 / {});...
00000c00: 20 09 09 74 68 61 74 2e 5f 63 6f 6e 6e 65 63 74 ..that._connect
00000c10: 28 29 3b 0d 0a 09 20 20 20 20 20 20 20 20 09 09 ();... ..
00000c20: 63 6f 6e 73 6f 6c 65 2e 6c 6f 67 28 27 6c 6f 61 console.log('loa
00000c30: 64 69 6e 67 20 74 68 65 20 6d 65 73 73 61 67 65 ding the message
00000c40: 73 2e 2e 2e 27 29 3b 0d 0a 09 20 20 20 20 20 20 s...');...
00000c50: 20 20 09 09 74 68 61 74 2e 5f 6c 6f 61 64 4d 65 ..that._loadMe
00000c60: 73 73 61 67 65 73 28 29 3b 0d 0a 09 09 20 20 20 ssages();....
00000c70: 20 20 20 20 20 09 74 68 61 74 2e 24 75 73 65 72 .that.$user
00000c80: 4c 69 2e 63 6c 69 63 6b 28 66 75 6e 63 74 69 6f Li.click(functio
00000c90: 6e 20 28 65 76 65 6e 74 29 20 7b 0d 0a 09 09 20 n (event) {....
00000ca0: 20 20 20 20 20 20 20 09 09 2f 2f 74 68 61 74 2e ..//that.
00000cb0: 5f 6c 6f 61 64 4d 65 73 73 61 67 65 73 28 29 3b _loadMessages();
00000cc0: 0d 0a 09 09 20 20 20 20 20 20 20 20 09 09 74 68 .... ..th
00000cd0: 61 74 2e 5f 63 6f 6e 6e 65 63 74 28 29 3b 0d 0a at._connect();..
00000ce0: 09 09 20 20 20 20 20 20 20 20 09 09 74 68 61 74 .. ..that
00000cf0: 2e 73 68 6f 77 28 74 68 61 74 2e 6f 70 74 69 6f .show(that.optio
00000d00: 6e 73 2e 70 6f 73 69 74 69 6f 6e 2e 78 2c 20 74 ns.position.x, t
00000d10: 68 61 74 2e 6f 70 74 69 6f 6e 73 2e 70 6f 73 69 hat.options.posi
00000d20: 74 69 6f 6e 2e 79 29 3b 0d 0a 09 09 20 20 20 20 tion.y);....
00000d30: 20 20 20 20 09 7d 29 3b 0d 0a 09 20 20 20 20 20 .});...
00000d40: 20 20 20 09 7d 29 3b 0d 0a 09 20 20 20 20 20 20 .});...
00000d50: 20 20 7d 0d 0a 09 09 7d 3b 0d 0a 09 09 0d 0a 09 }....};.......
00000d60: 09 63 68 61 74 2e 76 69 65 77 2e 55 73 65 72 56 .chat.view.UserV
00000d70: 69 65 77 2e 70 72 6f 74 6f 74 79 70 65 20 3d 20 iew.prototype =
00000d80: 7b 0d 0a 09 09 09 09 0d 0a 09 09 09 09 5f 6c 6f {............_lo
00000d90: 61 64 4d 65 73 73 61 67 65 73 3a 20 66 75 6e 63 adMessages: func
00000da0: 74 69 6f 6e 20 28 29 20 7b 0d 0a 09 09 09 09 09 tion () {.......
00000db0: 76 61 72 20 74 68 61 74 20 3d 20 74 68 69 73 3b var that = this;
00000dc0: 0d 0a 09 09 09 09 09 2f 2f 20 57 65 20 6c 6f 61 .......// We loa
00000dd0: 64 20 74 68 65 20 6d 65 73 73 61 67 65 73 20 73 d the messages s
00000de0: 74 6f 72 65 64 20 69 6e 20 6f 75 72 20 71 75 65 tored in our que
00000df0: 75 65 2e 20 52 65 6d 65 6d 62 65 72 20 74 68 61 ue. Remember tha
00000e00: 74 20 69 6e 20 74 68 61 74 20 71 75 65 75 65 20 t in that queue
00000e10: 61 72 65 20 73 74 6f 72 65 64 20 74 68 65 20 6d are stored the m
00000e20: 65 73 73 61 67 65 73 20 73 65 6e 74 20 66 72 6f essages sent fro
00000e30: 6d 20 75 73 20 74 6f 20 6f 75 72 20 63 6f 6e 74 m us to our cont
00000e40: 61 63 74 2c 20 61 6e 64 20 74 68 65 0d 0a 09 09 act, and the....
00000e50: 09 09 09 2f 2f 20 6d 65 73 73 61 67 65 73 20 73 ...// messages s
00000e60: 65 6e 74 20 62 79 20 6f 75 72 20 63 6f 6e 74 61 ent by our conta
00000e70: 63 74 20 74 6f 20 75 73 2e 0d 0a 09 09 09 09 09 ct to us........
00000e80: 74 68 69 73 2e 73 74 6f 6d 70 43 6c 69 65 6e 74 this.stompClient
00000e90: 44 65 73 74 69 6e 61 74 69 6f 6e 2e 73 75 62 73 Destination.subs
00000ea0: 63 72 69 62 65 28 27 2f 61 70 70 43 68 61 74 52 cribe('/appChatR
00000eb0: 65 6c 61 79 2f 63 68 61 74 2f 67 65 74 4d 65 73 elay/chat/getMes
00000ec0: 73 61 67 65 73 2f 27 2b 74 68 69 73 2e 24 63 6f sages/'+this.$co
00000ed0: 6e 74 61 69 6e 65 72 53 65 74 74 69 6e 67 73 2e ntainerSettings.
00000ee0: 70 61 72 61 6d 73 2e 75 73 65 72 4e 61 6d 65 20 params.userName
00000ef0: 2b 20 27 2d 27 20 2b 20 74 68 69 73 2e 24 75 73 + '-' + this.$us
00000f00: 65 72 4c 69 2e 74 65 78 74 28 29 2c 20 66 75 6e erLi.text(), fun
00000f10: 63 74 69 6f 6e 20 28 66 72 61 6d 65 29 20 7b 0d ction (frame) {.
00000f20: 0a 09 09 09 09 09 09 76 61 72 20 6d 65 73 73 61 .......var messa
00000f30: 67 65 73 20 3d 20 4a 53 4f 4e 2e 70 61 72 73 65 ges = JSON.parse
00000f40: 28 66 72 61 6d 65 2e 62 6f 64 79 29 3b 0d 0a 09 (frame.body);...
00000f50: 09 09 09 09 09 24 2e 65 61 63 68 28 6d 65 73 73 .....$.each(mess
00000f60: 61 67 65 73 2c 20 66 75 6e 63 74 69 6f 6e 20 28 ages, function (
00000f70: 69 6e 64 65 78 2c 20 6d 65 73 73 61 67 65 29 20 index, message)
00000f80: 7b 0d 0a 20 20 20 20 09 09 09 09 09 09 74 68 61 {.. ......tha
00000f90: 74 2e 61 64 64 4d 65 73 73 61 67 65 28 6d 65 73 t.addMessage(mes
00000fa0: 73 61 67 65 2c 20 6d 65 73 73 61 67 65 2e 73 65 sage, message.se
00000fb0: 6e 64 65 72 20 21 3d 3d 20 74 68 61 74 2e 24 63 nder !== that.$c
00000fc0: 6f 6e 74 61 69 6e 65 72 53 65 74 74 69 6e 67 73 ontainerSettings
00000fd0: 2e 70 61 72 61 6d 73 2e 75 73 65 72 4e 61 6d 65 .params.userName
00000fe0: 2c 20 6d 65 73 73 61 67 65 73 29 3b 09 09 09 09 , messages);....
00000ff0: 09 09 0d 0a 20 20 20 20 09 09 09 09 09 7d 29 3b .... .....});
00001000: 0d 0a 09 09 09 09 09 7d 29 3b 0d 0a 09 09 09 09 .......});......
00001010: 7d 2c 0d 0a 09 09 09 09 5f 63 6f 6e 6e 65 63 74 },......_connect
00001020: 3a 20 66 75 6e 63 74 69 6f 6e 20 28 29 20 7b 0d : function () {.
00001030: 0a 09 09 09 09 09 76 61 72 20 74 68 61 74 20 3d ......var that =
00001040: 20 74 68 69 73 3b 09 09 09 20 20 20 20 09 0d 0a this;... ...
00001050: 09 09 09 09 09 74 68 61 74 2e 24 62 75 74 74 6f .....that.$butto
00001060: 6e 53 75 62 6d 69 74 2e 63 6c 69 63 6b 28 66 75 nSubmit.click(fu
00001070: 6e 63 74 69 6f 6e 20 28 29 20 7b 0d 0a 09 09 09 nction () {.....
00001080: 20 20 20 20 20 20 20 20 20 20 20 20 63 6f 6e 73 cons
00001090: 6f 6c 65 2e 6c 6f 67 28 27 63 6c 69 63 6b 69 6e ole.log('clickin
000010a0: 67 20 73 65 6e 64 20 77 69 74 68 20 6d 65 73 73 g send with mess
000010b0: 61 67 65 3a 20 27 20 2b 20 74 68 61 74 2e 24 6d age: ' + that.$m
000010c0: 65 73 73 61 67 65 49 6e 70 75 74 2e 76 61 6c 28 essageInput.val(
000010d0: 29 29 3b 0d 0a 09 09 09 20 20 20 20 20 20 20 20 ));.....
000010e0: 20 20 20 20 69 66 20 28 74 68 61 74 2e 24 6d 65 if (that.$me
000010f0: 73 73 61 67 65 49 6e 70 75 74 2e 76 61 6c 28 29 ssageInput.val()
00001100: 29 20 7b 0d 0a 09 09 09 20 20 20 20 20 20 20 20 ) {.....
00001110: 20 20 20 20 09 76 61 72 20 6d 65 73 73 61 67 65 .var message
00001120: 43 68 61 74 20 3d 20 7b 0d 0a 09 09 09 20 20 20 Chat = {.....
00001130: 20 20 20 20 20 20 20 20 20 09 09 22 6d 65 73 73 .."mess
00001140: 61 67 65 22 3a 20 74 68 61 74 2e 24 6d 65 73 73 age": that.$mess
00001150: 61 67 65 49 6e 70 75 74 2e 76 61 6c 28 29 2c 0d ageInput.val(),.
00001160: 0a 09 09 09 20 20 20 20 20 20 20 20 20 20 20 20 ....
00001170: 09 09 22 73 65 6e 64 65 72 22 3a 20 74 68 61 74 .."sender": that
00001180: 2e 24 63 6f 6e 74 61 69 6e 65 72 53 65 74 74 69 .$containerSetti
00001190: 6e 67 73 2e 70 61 72 61 6d 73 2e 75 73 65 72 4e ngs.params.userN
000011a0: 61 6d 65 2c 0d 0a 09 09 09 20 20 20 20 20 20 20 ame,.....
000011b0: 20 20 20 20 20 09 09 22 72 65 63 69 70 69 65 6e .."recipien
000011c0: 74 22 3a 20 74 68 61 74 2e 24 75 73 65 72 4c 69 t": that.$userLi
000011d0: 2e 74 65 78 74 28 29 2c 0d 0a 2f 2f 09 09 09 20 .text(),..//...
000011e0: 20 20 20 20 20 20 20 20 20 20 20 09 09 22 74 69 .."ti
000011f0: 6d 65 22 3a 20 6e 65 77 20 44 61 74 65 28 29 2e me": new Date().
00001200: 74 6f 53 74 72 69 6e 67 28 29 2c 0d 0a 09 09 09 toString(),.....
00001210: 20 20 20 20 20 20 20 20 20 20 20 20 09 09 22 75 .."u
00001220: 73 65 72 57 69 6e 64 6f 77 54 69 6d 65 5a 6f 6e serWindowTimeZon
00001230: 65 22 3a 20 6e 65 77 20 44 61 74 65 28 29 2e 74 e": new Date().t
00001240: 6f 53 74 72 69 6e 67 28 29 2e 6d 61 74 63 68 28 oString().match(
00001250: 2f 47 4d 54 5c 2b 5b 30 2d 39 5d 5b 30 2d 39 5d /GMT\+[0-9][0-9]
00001260: 5b 30 2d 39 5d 5b 30 2d 39 5d 2f 29 5b 30 5d 2c [0-9][0-9]/)[0],
00001270: 0d 0a 09 09 09 20 20 20 20 20 20 20 20 20 20 20 .....
00001280: 20 09 09 22 69 64 22 3a 20 6e 65 77 20 44 61 74 .."id": new Dat
00001290: 65 28 29 2e 67 65 74 54 69 6d 65 28 29 2c 0d 0a e().getTime(),..
000012a0: 09 09 09 20 20 20 20 20 20 20 20 20 20 20 20 09 ... .
000012b0: 09 22 73 74 61 74 65 22 3a 20 22 50 45 4e 44 49 ."state": "PENDI
000012c0: 4e 47 5f 54 4f 5f 53 45 4e 44 22 0d 0a 09 09 09 NG_TO_SEND".....
000012d0: 20 20 20 20 20 20 20 20 20 20 20 20 09 7d 3b 0d .};.
000012e0: 0a 09 09 09 20 20 20 20 20 20 20 20 20 20 20 20 ....
000012f0: 09 74 68 61 74 2e 61 64 64 4d 65 73 73 61 67 65 .that.addMessage
00001300: 28 6d 65 73 73 61 67 65 43 68 61 74 2c 20 66 61 (messageChat, fa
00001310: 6c 73 65 29 3b 0d 0a 09 09 09 09 09 09 09 74 68 lse);.........th
00001320: 61 74 2e 24 6d 65 73 73 61 67 65 49 6e 70 75 74 at.$messageInput
00001330: 2e 76 61 6c 28 27 27 29 3b 0d 0a 09 09 09 09 09 .val('');.......
00001340: 09 09 74 68 61 74 2e 24 6d 65 73 73 61 67 65 49 ..that.$messageI
00001350: 6e 70 75 74 2e 66 6f 63 75 73 28 29 3b 0d 0a 09 nput.focus();...
00001360: 09 09 09 09 09 09 74 68 61 74 2e 73 74 6f 6d 70 ......that.stomp
00001370: 43 6c 69 65 6e 74 44 65 73 74 69 6e 61 74 69 6f ClientDestinatio
00001380: 6e 2e 73 65 6e 64 28 27 2f 61 70 70 43 68 61 74 n.send('/appChat
00001390: 52 65 6c 61 79 2f 63 68 61 74 2f 73 65 6e 64 4d Relay/chat/sendM
000013a0: 65 73 73 61 67 65 2f 27 20 2b 20 6d 65 73 73 61 essage/' + messa
000013b0: 67 65 43 68 61 74 2e 73 65 6e 64 65 72 20 2b 20 geChat.sender +
000013c0: 27 2f 27 20 2b 20 6d 65 73 73 61 67 65 43 68 61 '/' + messageCha
000013d0: 74 2e 72 65 63 69 70 69 65 6e 74 2c 20 7b 7d 2c t.recipient, {},
000013e0: 20 4a 53 4f 4e 2e 73 74 72 69 6e 67 69 66 79 28 JSON.stringify(
000013f0: 6d 65 73 73 61 67 65 43 68 61 74 29 29 3b 0d 0a messageChat));..
00001400: 2f 2f 09 09 09 20 20 20 20 20 20 20 20 20 20 20 //...
00001410: 20 09 73 74 6f 6d 70 43 6c 69 65 6e 74 44 65 73 .stompClientDes
00001420: 74 69 6e 61 74 69 6f 6e 2e 73 65 6e 64 28 27 2f tination.send('/
00001430: 61 70 70 43 68 61 74 52 65 6c 61 79 2f 63 68 61 appChatRelay/cha
00001440: 74 2f 73 65 6e 64 4d 65 73 73 61 67 65 27 2c 20 t/sendMessage',
00001450: 7b 27 73 69 6d 70 55 73 65 72 27 3a 20 22 6b 65 {'simpUser': "ke
00001460: 6c 75 63 68 69 73 22 7d 2c 20 4a 53 4f 4e 2e 73 luchis"}, JSON.s
00001470: 74 72 69 6e 67 69 66 79 28 6d 65 73 73 61 67 65 tringify(message
00001480: 43 68 61 74 29 29 3b 0d 0a 09 09 09 20 20 20 20 Chat));.....
00001490: 20 20 20 20 20 20 20 20 7d 0d 0a 09 09 09 20 20 }.....
000014a0: 20 20 20 20 20 20 7d 29 3b 0d 0a 09 09 09 09 7d });......}
000014b0: 2c 0d 0a 09 09 09 09 5f 64 69 73 63 6f 6e 6e 65 ,......_disconne
000014c0: 63 74 3a 20 66 75 6e 63 74 69 6f 6e 20 28 29 20 ct: function ()
000014d0: 7b 0d 0a 09 09 09 09 09 0d 0a 09 09 09 09 7d 2c {.............},
000014e0: 0d 0a 09 09 09 09 5f 69 6e 69 74 3a 20 66 75 6e ......_init: fun
000014f0: 63 74 69 6f 6e 20 28 29 20 7b 0d 0a 09 09 09 09 ction () {......
00001500: 09 76 61 72 20 74 68 61 74 20 3d 20 74 68 69 73 .var that = this
00001510: 3b 0d 0a 09 09 09 09 09 69 66 20 28 21 74 68 61 ;.......if (!tha
00001520: 74 2e 6f 70 74 69 6f 6e 73 2e 68 61 73 4c 6f 61 t.options.hasLoa
00001530: 64 65 64 29 20 7b 0d 0a 09 09 09 09 09 09 74 68 ded) {........th
00001540: 61 74 2e 24 75 73 65 72 57 69 6e 64 6f 77 2e 64 at.$userWindow.d
00001550: 69 61 6c 6f 67 28 7b 0d 0a 09 09 09 09 09 09 09 ialog({.........
00001560: 61 75 74 6f 4f 70 65 6e 3a 20 66 61 6c 73 65 2c autoOpen: false,
00001570: 0d 0a 09 09 09 09 09 09 09 77 69 64 74 68 3a 20 .........width:
00001580: 74 68 61 74 2e 6f 70 74 69 6f 6e 73 2e 77 69 64 that.options.wid
00001590: 74 68 2c 0d 0a 09 09 09 09 09 09 09 68 65 69 67 th,.........heig
000015a0: 68 74 3a 20 74 68 61 74 2e 6f 70 74 69 6f 6e 73 ht: that.options
000015b0: 2e 68 65 69 67 68 74 2c 0d 0a 09 09 09 09 09 09 .height,........
000015c0: 09 6f 70 65 6e 3a 20 66 75 6e 63 74 69 6f 6e 20 .open: function
000015d0: 28 65 76 65 6e 74 2c 20 75 69 29 20 7b 0d 0a 09 (event, ui) {...
000015e0: 09 09 09 09 09 09 09 74 68 61 74 2e 24 6d 65 73 .......that.$mes
000015f0: 73 61 67 65 49 6e 70 75 74 2e 66 6f 63 75 73 28 sageInput.focus(
00001600: 29 3b 0d 0a 09 09 09 09 09 09 09 09 69 66 20 28 );..........if (
00001610: 74 68 61 74 2e 24 63 6f 6e 74 61 69 6e 65 72 53 that.$containerS
00001620: 65 74 74 69 6e 67 73 2e 68 61 73 46 6f 63 75 73 ettings.hasFocus
00001630: 20 21 3d 20 66 61 6c 73 65 29 20 7b 0d 0a 09 09 != false) {....
00001640: 09 09 09 09 09 09 09 74 68 61 74 2e 6c 6f 6f 6b .......that.look
00001650: 46 6f 72 43 6f 6e 66 69 72 6d 69 6e 67 52 65 61 ForConfirmingRea
00001660: 64 4d 65 73 73 61 67 65 73 28 29 3b 0d 0a 09 09 dMessages();....
00001670: 09 09 09 09 09 09 7d 0d 0a 09 09 09 09 09 09 09 ......}.........
00001680: 7d 2c 0d 0a 09 09 09 09 09 09 09 63 6c 6f 73 65 },.........close
00001690: 3a 20 66 75 6e 63 74 69 6f 6e 20 28 65 76 65 6e : function (even
000016a0: 74 2c 20 75 69 29 20 7b 0d 0a 09 09 09 09 09 09 t, ui) {........
000016b0: 09 09 74 68 61 74 2e 6f 70 74 69 6f 6e 73 2e 68 ..that.options.h
000016c0: 61 73 4c 6f 61 64 65 64 20 3d 20 66 61 6c 73 65 asLoaded = false
000016d0: 3b 09 09 0d 0a 09 09 09 09 09 09 09 09 74 68 61 ;............tha
000016e0: 74 2e 24 75 73 65 72 57 69 6e 64 6f 77 2e 64 69 t.$userWindow.di
000016f0: 61 6c 6f 67 28 27 64 65 73 74 72 6f 79 27 29 3b alog('destroy');
00001700: 0d 0a 09 09 09 09 09 09 09 7d 0d 0a 09 09 09 09 .........}......
00001710: 09 09 7d 29 3b 0d 0a 09 09 09 09 09 09 74 68 61 ..});........tha
00001720: 74 2e 6f 70 74 69 6f 6e 73 2e 68 61 73 4c 6f 61 t.options.hasLoa
00001730: 64 65 64 20 3d 20 74 72 75 65 3b 0d 0a 09 09 09 ded = true;.....
00001740: 09 09 7d 0d 0a 09 09 09 09 09 69 66 20 28 21 74 ..}.......if (!t
00001750: 68 61 74 2e 69 73 55 73 65 72 57 69 6e 64 6f 77 hat.isUserWindow
00001760: 4f 70 65 6e 28 29 29 20 7b 0d 0a 09 09 09 09 09 Open()) {.......
00001770: 09 74 68 61 74 2e 24 75 73 65 72 57 69 6e 64 6f .that.$userWindo
00001780: 77 2e 64 69 61 6c 6f 67 28 27 6f 70 65 6e 27 29 w.dialog('open')
00001790: 3b 0d 0a 09 09 09 09 09 7d 0d 0a 09 09 09 09 09 ;.......}.......
000017a0: 74 68 61 74 2e 24 6d 65 73 73 61 67 65 73 2e 70 that.$messages.p
000017b0: 72 6f 70 28 27 73 63 72 6f 6c 6c 54 6f 70 27 2c rop('scrollTop',
000017c0: 20 74 68 69 73 2e 24 6d 65 73 73 61 67 65 73 2e this.$messages.
000017d0: 70 72 6f 70 28 27 73 63 72 6f 6c 6c 48 65 69 67 prop('scrollHeig
000017e0: 68 74 27 29 29 3b 0d 0a 09 09 09 09 7d 2c 0d 0a ht'));......},..
000017f0: 09 09 09 09 73 68 6f 77 3a 20 66 75 6e 63 74 69 ....show: functi
00001800: 6f 6e 20 28 78 2c 20 79 29 20 7b 0d 0a 09 09 09 on (x, y) {.....
00001810: 09 09 76 61 72 20 74 68 61 74 20 3d 20 74 68 69 ..var that = thi
00001820: 73 3b 0d 0a 09 09 09 09 09 74 68 61 74 2e 5f 69 s;.......that._i
00001830: 6e 69 74 28 29 3b 0d 0a 09 09 09 09 09 2f 2f 74 nit();.......//t
00001840: 68 61 74 2e 24 75 73 65 72 57 69 6e 64 6f 77 2e hat.$userWindow.
00001850: 64 69 61 6c 6f 67 28 22 6f 70 65 6e 22 29 3b 0d dialog("open");.
00001860: 0a 09 09 09 09 7d 2c 0d 0a 09 09 09 09 61 64 64 .....},......add
00001870: 4d 65 73 73 61 67 65 3a 20 66 75 6e 63 74 69 6f Message: functio
00001880: 6e 20 28 6d 65 73 73 61 67 65 2c 20 72 65 63 65 n (message, rece
00001890: 69 76 65 64 2c 20 6d 65 73 73 61 67 65 73 29 20 ived, messages)
000018a0: 7b 0d 0a 09 09 09 09 09 74 68 69 73 2e 71 75 65 {.......this.que
000018b0: 75 65 4d 65 73 73 61 67 65 73 2e 70 75 73 68 28 ueMessages.push(
000018c0: 6d 65 73 73 61 67 65 29 3b 0d 0a 09 09 09 09 09 message);.......
000018d0: 76 61 72 20 24 70 20 3d 20 24 28 27 73 70 61 6e var $p = $('span
000018e0: 3a 64 61 74 61 28 6d 65 73 73 61 67 65 49 64 29 :data(messageId)
000018f0: 27 2c 20 74 68 69 73 2e 24 75 73 65 72 57 69 6e ', this.$userWin
00001900: 64 6f 77 29 2e 66 69 6c 74 65 72 28 66 75 6e 63 dow).filter(func
00001910: 74 69 6f 6e 20 28 29 20 7b 72 65 74 75 72 6e 20 tion () {return
00001920: 24 28 74 68 69 73 29 2e 64 61 74 61 28 27 6d 65 $(this).data('me
00001930: 73 73 61 67 65 49 64 27 29 20 3d 3d 20 6d 65 73 ssageId') == mes
00001940: 73 61 67 65 2e 69 64 7d 29 3b 0d 0a 09 09 09 09 sage.id});......
00001950: 09 69 66 20 28 6d 65 73 73 61 67 65 2e 75 73 65 .if (message.use
00001960: 72 54 69 6d 65 5a 6f 6e 65 29 20 7b 0d 0a 09 09 rTimeZone) {....
00001970: 09 09 09 09 2f 2f 0d 0a 09 09 09 09 09 7d 20 65 ....//.......} e
00001980: 6c 73 65 20 69 66 20 28 6d 65 73 73 61 67 65 2e lse if (message.
00001990: 74 69 6d 65 20 26 26 20 6d 65 73 73 61 67 65 2e time && message.
000019a0: 75 73 65 72 57 69 6e 64 6f 77 54 69 6d 65 5a 6f userWindowTimeZo
000019b0: 6e 65 29 20 7b 0d 0a 09 09 09 09 09 09 2f 2f 20 ne) {........//
000019c0: 49 20 63 6f 6e 76 65 72 74 20 74 68 65 20 6d 65 I convert the me
000019d0: 73 73 61 67 65 20 75 73 69 6e 67 20 74 68 65 20 ssage using the
000019e0: 74 69 6d 65 20 7a 6f 6e 65 20 6f 66 20 74 68 65 time zone of the
000019f0: 20 77 69 6e 64 6f 77 20 6f 66 20 74 68 65 20 75 window of the u
00001a00: 73 65 72 0d 0a 09 09 09 09 09 09 6d 65 73 73 61 ser........messa
00001a10: 67 65 2e 74 69 6d 65 20 3d 20 6d 6f 6d 65 6e 74 ge.time = moment
00001a20: 28 6d 65 73 73 61 67 65 2e 74 69 6d 65 29 2e 75 (message.time).u
00001a30: 74 63 4f 66 66 73 65 74 28 6d 65 73 73 61 67 65 tcOffset(message
00001a40: 2e 75 73 65 72 57 69 6e 64 6f 77 54 69 6d 65 5a .userWindowTimeZ
00001a50: 6f 6e 65 29 2e 66 6f 72 6d 61 74 28 27 59 59 59 one).format('YYY
00001a60: 59 2d 4d 4d 2d 44 44 20 48 48 3a 6d 6d 20 5a 27 Y-MM-DD HH:mm Z'
00001a70: 29 3b 0d 0a 09 09 09 09 09 7d 0d 0a 09 09 09 09 );.......}......
00001a80: 09 76 61 72 20 74 69 6d 65 54 65 78 74 20 3d 20 .var timeText =
00001a90: 6d 65 73 73 61 67 65 2e 74 69 6d 65 20 3f 20 22 message.time ? "
00001aa0: 3c 73 70 61 6e 20 63 6c 61 73 73 3d 27 63 68 61 <span class='cha
00001ab0: 74 2d 6d 65 73 73 61 67 65 2d 74 69 6d 65 27 3e t-message-time'>
00001ac0: 22 2b 20 6d 65 73 73 61 67 65 2e 74 69 6d 65 2e "+ message.time.
00001ad0: 6d 61 74 63 68 28 2f 28 32 5b 30 2d 33 5d 7c 5b match(/(2[0-3]|[
00001ae0: 30 31 5d 3f 5b 30 2d 39 5d 29 3a 28 5b 30 2d 35 01]?[0-9]):([0-5
00001af0: 5d 3f 5b 30 2d 39 5d 29 2f 29 5b 30 5d 20 2b 20 ]?[0-9])/)[0] +
00001b00: 22 3c 2f 73 70 61 6e 3e 22 20 3a 20 27 27 3b 0d "</span>" : '';.
00001b10: 0a 09 09 09 09 09 76 61 72 20 74 69 63 6b 20 3d ......var tick =
00001b20: 20 27 3c 73 70 61 6e 20 63 6c 61 73 73 3d 22 63 '<span class="c
00001b30: 68 61 74 2d 6d 65 73 73 61 67 65 2d 74 69 63 6b hat-message-tick
00001b40: 20 64 65 66 61 75 6c 74 22 3e 5c 75 32 37 31 33 default">\u2713
00001b50: 3c 2f 73 70 61 6e 3e 27 3b 0d 0a 09 09 09 09 09 </span>';.......
00001b60: 2f 2f 20 49 66 20 74 68 65 20 6d 65 73 73 61 67 // If the messag
00001b70: 65 20 74 68 61 74 20 49 20 73 65 6e 74 20 68 61 e that I sent ha
00001b80: 73 20 62 65 65 6e 20 72 65 63 65 69 76 65 64 20 s been received
00001b90: 62 79 20 74 68 65 20 73 65 72 76 65 72 20 6f 72 by the server or
00001ba0: 20 49 20 68 61 76 65 20 72 65 63 65 69 76 65 64 I have received
00001bb0: 20 74 68 65 20 6e 6f 74 69 66 69 63 61 74 69 6f the notificatio
00001bc0: 6e 20 62 79 20 74 68 65 20 63 6c 69 65 6e 74 20 n by the client
00001bd0: 28 75 73 65 72 20 64 65 73 74 69 6e 61 74 69 6f (user destinatio
00001be0: 6e 29 20 0d 0a 09 09 09 09 09 2f 2f 20 74 68 61 n) .......// tha
00001bf0: 74 20 48 65 20 68 61 73 20 72 65 63 65 69 76 65 t He has receive
00001c00: 64 20 74 68 65 20 6d 65 73 73 61 67 65 0d 0a 09 d the message...
00001c10: 09 09 09 09 76 61 72 20 74 69 63 6b 54 65 78 74 ....var tickText
00001c20: 20 3d 20 28 6d 65 73 73 61 67 65 2e 72 65 63 65 = (message.rece
00001c30: 69 76 65 64 42 79 53 65 72 76 65 72 20 7c 7c 20 ivedByServer ||
00001c40: 6d 65 73 73 61 67 65 2e 72 65 63 65 69 76 65 64 message.received
00001c50: 42 79 43 6c 69 65 6e 74 29 20 26 26 20 21 72 65 ByClient) && !re
00001c60: 63 65 69 76 65 64 20 3f 20 74 69 63 6b 20 3a 20 ceived ? tick :
00001c70: 27 27 3b 0d 0a 09 09 09 09 09 2f 2f 20 49 66 20 '';.......// If
00001c80: 74 68 65 20 6d 65 73 73 61 67 65 20 69 73 20 69 the message is i
00001c90: 6e 20 74 68 65 20 77 69 6e 64 6f 77 20 20 0d 0a n the window ..
00001ca0: 09 09 09 09 09 69 66 20 28 24 70 20 26 26 20 24 .....if ($p && $
00001cb0: 70 2e 6c 65 6e 67 74 68 3e 30 29 7b 0d 0a 09 09 p.length>0){....
00001cc0: 09 09 09 09 2f 2f 20 49 66 20 74 68 65 20 6d 65 ....// If the me
00001cd0: 73 73 61 67 65 20 74 65 78 74 20 68 61 73 6e 27 ssage text hasn'
00001ce0: 74 20 64 6f 75 62 6c 65 20 63 6b 65 63 6b 20 e2 t double ckeck .
00001cf0: 9c 93 e2 9c 93 20 20 49 20 63 61 6e 20 61 64 64 ..... I can add
00001d00: 20 61 20 63 68 65 63 6b 0d 0a 09 09 09 09 09 09 a check........
00001d10: 69 66 20 28 24 28 27 2e 63 68 61 74 2d 6d 65 73 if ($('.chat-mes
00001d20: 73 61 67 65 2d 74 69 63 6b 27 2c 20 24 70 29 2e sage-tick', $p).
00001d30: 6c 65 6e 67 74 68 20 3c 20 32 29 20 7b 0d 0a 09 length < 2) {...
00001d40: 09 09 09 09 09 09 2f 2f 20 49 66 20 74 68 65 20 ......// If the
00001d50: 6d 65 73 73 61 67 65 73 20 74 65 78 74 20 68 61 messages text ha
00001d60: 73 6e 27 74 20 74 68 65 20 74 69 6d 65 20 61 64 sn't the time ad
00001d70: 64 65 64 20 49 20 61 64 64 20 69 74 0d 0a 09 09 ded I add it....
00001d80: 09 09 09 09 09 24 70 2e 68 74 6d 6c 28 24 70 2e .....$p.html($p.
00001d90: 68 74 6d 6c 28 29 2b 20 28 21 24 70 2e 68 74 6d html()+ (!$p.htm
00001da0: 6c 28 29 2e 6d 61 74 63 68 28 2f 28 32 5b 30 2d l().match(/(2[0-
00001db0: 33 5d 7c 5b 30 31 5d 3f 5b 30 2d 39 5d 29 3a 28 3]|[01]?[0-9]):(
00001dc0: 5b 30 2d 35 5d 3f 5b 30 2d 39 5d 29 2f 29 20 3f [0-5]?[0-9])/) ?
00001dd0: 20 74 69 6d 65 54 65 78 74 20 3a 20 27 27 29 20 timeText : '')
00001de0: 2b 20 74 69 63 6b 54 65 78 74 29 3b 09 09 09 09 + tickText);....
00001df0: 09 09 09 0d 0a 09 09 09 09 09 09 7d 0d 0a 09 09 ...........}....
00001e00: 09 09 09 7d 20 65 6c 73 65 20 7b 20 2f 2f 20 49 ...} else { // I
00001e10: 66 20 74 68 65 20 6d 65 73 73 61 67 65 20 69 73 f the message is
00001e20: 20 6e 6f 74 20 69 6e 20 74 68 65 20 77 69 6e 64 not in the wind
00001e30: 6f 77 20 69 73 20 67 6f 69 6e 67 20 74 6f 20 62 ow is going to b
00001e40: 65 20 61 64 64 65 64 20 74 6f 20 74 68 65 20 77 e added to the w
00001e50: 69 6e 64 6f 77 0d 0a 09 09 09 09 09 09 76 61 72 indow........var
00001e60: 20 24 6d 73 67 43 68 61 74 44 69 76 20 3d 20 28 $msgChatDiv = (
00001e70: 72 65 63 65 69 76 65 64 20 3f 20 24 28 22 3c 64 received ? $("<d
00001e80: 69 76 20 63 6c 61 73 73 3d 27 6d 65 73 73 61 67 iv class='messag
00001e90: 65 20 72 65 63 65 69 76 65 64 2d 6d 65 73 73 61 e received-messa
00001ea0: 67 65 27 3e 3c 2f 64 69 76 3e 22 29 20 3a 20 24 ge'></div>") : $
00001eb0: 28 22 3c 64 69 76 20 63 6c 61 73 73 3d 27 6d 65 ("<div class='me
00001ec0: 73 73 61 67 65 20 73 65 6e 74 2d 6d 65 73 73 61 ssage sent-messa
00001ed0: 67 65 27 3e 3c 2f 64 69 76 3e 22 29 29 3b 09 09 ge'></div>"));..
00001ee0: 09 09 09 09 0d 0a 09 09 09 09 09 09 76 61 72 20 ............var
00001ef0: 24 70 20 3d 20 28 72 65 63 65 69 76 65 64 20 3f $p = (received ?
00001f00: 20 24 28 22 3c 73 70 61 6e 20 63 6c 61 73 73 3d $("<span class=
00001f10: 27 63 68 61 74 2d 6d 65 73 73 61 67 65 20 63 68 'chat-message ch
00001f20: 61 74 2d 72 65 63 65 69 76 65 64 2d 6d 65 73 73 at-received-mess
00001f30: 61 67 65 27 3e 22 29 20 3a 20 24 28 22 3c 73 70 age'>") : $("<sp
00001f40: 61 6e 20 63 6c 61 73 73 3d 27 63 68 61 74 2d 6d an class='chat-m
00001f50: 65 73 73 61 67 65 20 63 68 61 74 2d 73 65 6e 74 essage chat-sent
00001f60: 2d 6d 65 73 73 61 67 65 27 3e 22 29 29 3b 0d 0a -message'>"));..
00001f70: 09 09 09 09 09 09 24 70 2e 64 61 74 61 28 27 6d ......$p.data('m
00001f80: 65 73 73 61 67 65 2d 69 64 27 2c 20 6d 65 73 73 essage-id', mess
00001f90: 61 67 65 2e 69 64 29 3b 0d 0a 09 09 09 09 09 09 age.id);........
00001fa0: 69 66 20 28 6d 65 73 73 61 67 65 2e 73 74 61 74 if (message.stat
00001fb0: 65 20 3d 3d 3d 20 27 44 45 4c 49 56 45 52 45 44 e === 'DELIVERED
00001fc0: 27 29 20 7b 0d 0a 09 09 09 09 09 09 09 74 69 63 ') {.........tic
00001fd0: 6b 54 65 78 74 2b 3d 74 69 63 6b 54 65 78 74 3b kText+=tickText;
00001fe0: 0d 0a 09 09 09 09 09 09 7d 0d 0a 09 09 09 09 09 ........}.......
00001ff0: 09 24 70 2e 68 74 6d 6c 28 6d 65 73 73 61 67 65 .$p.html(message
00002000: 2e 6d 65 73 73 61 67 65 20 2b 20 74 69 6d 65 54 .message + timeT
00002010: 65 78 74 20 2b 20 74 69 63 6b 54 65 78 74 29 3b ext + tickText);
00002020: 0d 0a 09 09 09 09 09 09 74 68 69 73 2e 24 6d 65 ........this.$me
00002030: 73 73 61 67 65 73 2e 61 70 70 65 6e 64 28 24 6d ssages.append($m
00002040: 73 67 43 68 61 74 44 69 76 2e 61 70 70 65 6e 64 sgChatDiv.append
00002050: 28 27 3c 73 70 61 6e 20 63 6c 61 73 73 3d 22 74 ('<span class="t
00002060: 61 69 6c 2d 63 6f 6e 74 61 69 6e 65 72 20 68 69 ail-container hi
00002070: 67 68 6c 69 67 68 74 22 3e 3c 2f 73 70 61 6e 3e ghlight"></span>
00002080: 27 29 2e 61 70 70 65 6e 64 28 24 70 29 29 3b 09 ').append($p));.
00002090: 09 09 09 09 09 09 09 09 09 09 09 0d 0a 09 09 09 ................
000020a0: 09 09 7d 0d 0a 0d 0a 09 09 09 09 09 69 66 20 28 ..}.........if (
000020b0: 6d 65 73 73 61 67 65 2e 73 74 61 74 65 20 3d 3d message.state ==
000020c0: 3d 20 27 50 45 4e 44 49 4e 47 5f 54 4f 5f 53 45 = 'PENDING_TO_SE
000020d0: 4e 44 27 20 26 26 20 6d 65 73 73 61 67 65 73 20 ND' && messages
000020e0: 26 26 20 6d 65 73 73 61 67 65 73 2e 6c 65 6e 67 && messages.leng
000020f0: 74 68 20 3e 20 31 29 20 7b 0d 0a 09 09 09 09 09 th > 1) {.......
00002100: 09 2f 2f 20 57 65 20 6c 6f 6f 6b 20 66 6f 72 20 .// We look for
00002110: 61 20 6d 65 73 73 61 67 65 20 52 45 43 45 49 56 a message RECEIV
00002120: 45 44 20 62 79 20 74 68 65 20 73 61 6d 65 20 69 ED by the same i
00002130: 64 20 69 6e 20 74 68 65 20 6d 65 73 73 61 67 65 d in the message
00002140: 73 20 72 65 63 65 69 76 65 64 0d 0a 09 09 09 09 s received......
00002150: 09 09 76 61 72 20 72 65 63 65 69 76 65 64 4d 65 ..var receivedMe
00002160: 73 73 61 67 65 20 3d 20 24 2e 67 72 65 70 28 6d ssage = $.grep(m
00002170: 65 73 73 61 67 65 73 2c 20 66 75 6e 63 74 69 6f essages, functio
00002180: 6e 20 28 61 29 20 7b 20 72 65 74 75 72 6e 20 61 n (a) { return a
00002190: 2e 69 64 20 3d 3d 3d 20 6d 65 73 73 61 67 65 2e .id === message.
000021a0: 69 64 20 26 26 20 61 2e 73 74 61 74 65 20 3d 3d id && a.state ==
000021b0: 3d 20 27 52 45 43 45 49 56 45 44 27 3b 20 7d 29 = 'RECEIVED'; })
000021c0: 3b 0d 0a 09 09 09 09 09 09 69 66 20 28 21 28 72 ;........if (!(r
000021d0: 65 63 65 69 76 65 64 4d 65 73 73 61 67 65 20 26 eceivedMessage &
000021e0: 26 20 72 65 63 65 69 76 65 64 4d 65 73 73 61 67 & receivedMessag
000021f0: 65 2e 6c 65 6e 67 74 68 20 3e 20 30 29 29 20 7b e.length > 0)) {
00002200: 0d 0a 09 09 09 09 09 09 09 74 68 69 73 2e 63 6f .........this.co
00002210: 6e 66 69 72 6d 52 65 63 65 69 76 65 64 4d 65 73 nfirmReceivedMes
00002220: 73 61 67 65 28 6d 65 73 73 61 67 65 29 3b 0d 0a sage(message);..
00002230: 09 09 09 09 09 09 7d 0d 0a 09 09 09 09 09 7d 20 ......}.......}
00002240: 65 6c 73 65 20 69 66 20 28 6d 65 73 73 61 67 65 else if (message
00002250: 2e 73 74 61 74 65 20 3d 3d 3d 20 27 52 45 41 44 .state === 'READ
00002260: 27 20 26 26 20 21 72 65 63 65 69 76 65 64 29 20 ' && !received)
00002270: 7b 0d 0a 09 09 09 09 09 09 24 28 27 2e 63 68 61 {........$('.cha
00002280: 74 2d 6d 65 73 73 61 67 65 2d 74 69 63 6b 27 2c t-message-tick',
00002290: 20 24 70 29 2e 72 65 6d 6f 76 65 43 6c 61 73 73 $p).removeClass
000022a0: 28 27 64 65 66 61 75 6c 74 27 29 2e 61 64 64 43 ('default').addC
000022b0: 6c 61 73 73 28 27 72 65 61 64 27 29 3b 0d 0a 09 lass('read');...
000022c0: 09 09 09 09 7d 0d 0a 09 09 09 09 09 24 70 2e 64 ....}.......$p.d
000022d0: 61 74 61 28 27 73 74 61 74 65 27 2c 20 6d 65 73 ata('state', mes
000022e0: 73 61 67 65 2e 73 74 61 74 65 29 3b 0d 0a 09 09 sage.state);....
000022f0: 09 09 09 74 68 69 73 2e 24 6d 65 73 73 61 67 65 ...this.$message
00002300: 73 2e 70 72 6f 70 28 27 73 63 72 6f 6c 6c 54 6f s.prop('scrollTo
00002310: 70 27 2c 20 74 68 69 73 2e 24 6d 65 73 73 61 67 p', this.$messag
00002320: 65 73 2e 70 72 6f 70 28 27 73 63 72 6f 6c 6c 48 es.prop('scrollH
00002330: 65 69 67 68 74 27 29 29 3b 0d 0a 09 09 09 09 7d eight'));......}
00002340: 2c 0d 0a 09 09 09 09 67 65 74 43 68 61 74 57 69 ,......getChatWi
00002350: 6e 64 6f 77 3a 20 66 75 6e 63 74 69 6f 6e 20 28 ndow: function (
00002360: 29 20 7b 0d 0a 09 09 09 09 09 72 65 74 75 72 6e ) {.......return
00002370: 20 74 68 69 73 2e 24 75 73 65 72 57 69 6e 64 6f this.$userWindo
00002380: 77 3b 0d 0a 09 09 09 09 7d 2c 0d 0a 09 09 09 09 w;......},......
00002390: 63 6c 65 61 6e 4d 65 73 73 61 67 65 3a 20 66 75 cleanMessage: fu
000023a0: 6e 63 74 69 6f 6e 20 28 6d 65 73 73 61 67 65 29 nction (message)
000023b0: 20 7b 0d 0a 09 09 09 09 09 6d 65 73 73 61 67 65 {.......message
000023c0: 2e 6d 65 73 73 61 67 65 3d 6e 75 6c 6c 3b 0d 0a .message=null;..
000023d0: 09 09 09 09 09 6d 65 73 73 61 67 65 2e 74 69 6d .....message.tim
000023e0: 65 3d 6e 75 6c 6c 3b 0d 0a 09 09 09 09 09 72 65 e=null;.......re
000023f0: 74 75 72 6e 20 6d 65 73 73 61 67 65 3b 0d 0a 09 turn message;...
00002400: 09 09 09 7d 2c 0d 0a 09 09 09 09 63 6f 6e 66 69 ...},......confi
00002410: 72 6d 52 65 63 65 69 76 65 64 4d 65 73 73 61 67 rmReceivedMessag
00002420: 65 3a 20 66 75 6e 63 74 69 6f 6e 20 28 6d 65 73 e: function (mes
00002430: 73 61 67 65 29 20 7b 0d 0a 09 09 09 09 09 76 61 sage) {.......va
00002440: 72 20 74 68 61 74 20 3d 20 74 68 69 73 3b 0d 0a r that = this;..
00002450: 09 09 09 09 09 6d 65 73 73 61 67 65 2e 72 65 63 .....message.rec
00002460: 65 69 76 65 64 42 79 43 6c 69 65 6e 74 3d 74 72 eivedByClient=tr
00002470: 75 65 3b 0d 0a 09 09 09 09 09 2f 2f 20 57 65 20 ue;.......// We
00002480: 73 65 6e 74 20 61 20 6d 65 73 73 61 67 65 20 74 sent a message t
00002490: 6f 20 74 68 65 20 73 65 6e 64 65 72 20 69 6e 64 o the sender ind
000024a0: 69 63 61 74 69 6e 67 20 74 68 61 74 20 77 65 20 icating that we
000024b0: 68 61 76 65 20 72 65 63 65 69 76 65 64 20 69 74 have received it
000024c0: 73 20 6d 65 73 73 61 67 65 20 28 73 6f 20 74 68 s message (so th
000024d0: 61 74 20 74 68 65 20 73 65 6e 64 65 72 20 63 61 at the sender ca
000024e0: 6e 20 6d 61 72 6b 20 64 6f 75 62 6c 65 20 63 68 n mark double ch
000024f0: 65 63 6b 20 69 6e 20 69 74 73 20 75 73 65 72 20 eck in its user
00002500: 63 68 61 74 20 77 69 6e 64 6f 77 29 0d 0a 09 09 chat window)....
00002510: 09 09 09 6d 65 73 73 61 67 65 2e 73 74 61 74 65 ...message.state
00002520: 3d 22 44 45 4c 49 56 45 52 45 44 22 3b 09 09 09 ="DELIVERED";...
00002530: 09 09 09 09 0d 0a 09 09 09 09 09 2f 2f 74 68 61 ...........//tha
00002540: 74 2e 73 74 6f 6d 70 43 6c 69 65 6e 74 44 65 73 t.stompClientDes
00002550: 74 69 6e 61 74 69 6f 6e 2e 73 65 6e 64 28 27 2f tination.send('/
00002560: 65 78 63 68 61 6e 67 65 2f 63 68 61 74 44 69 72 exchange/chatDir
00002570: 65 63 74 45 78 63 68 61 6e 67 65 2f 6d 65 73 73 ectExchange/mess
00002580: 61 67 65 73 2d 27 20 2b 20 6d 65 73 73 61 67 65 ages-' + message
00002590: 2e 73 65 6e 64 65 72 20 2b 20 27 2d 6e 6f 74 69 .sender + '-noti
000025a0: 66 69 63 61 74 69 6f 6e 27 2c 20 7b 7d 2c 20 64 fication', {}, d
000025b0: 65 6c 69 76 65 72 65 64 4d 65 73 73 61 67 65 29 eliveredMessage)
000025c0: 3b 0d 0a 09 09 09 09 09 2f 2f 20 57 65 20 73 65 ;.......// We se
000025d0: 6e 64 20 74 68 65 20 6d 65 73 73 61 67 65 20 61 nd the message a
000025e0: 67 61 69 6e 20 74 6f 20 74 68 65 20 73 65 6e 64 gain to the send
000025f0: 65 72 20 73 6f 20 74 68 61 74 20 69 74 73 20 71 er so that its q
00002600: 75 65 75 65 20 74 6f 20 73 74 6f 72 65 20 74 68 ueue to store th
00002610: 65 20 6e 65 77 20 73 74 61 74 65 20 28 44 45 4c e new state (DEL
00002620: 49 56 45 52 45 44 29 20 6f 66 20 74 68 69 73 20 IVERED) of this
00002630: 6d 65 73 73 61 67 65 2e 0d 0a 09 09 09 09 09 74 message........t
00002640: 68 61 74 2e 73 74 6f 6d 70 43 6c 69 65 6e 74 44 hat.stompClientD
00002650: 65 73 74 69 6e 61 74 69 6f 6e 2e 73 65 6e 64 28 estination.send(
00002660: 27 2f 65 78 63 68 61 6e 67 65 2f 63 68 61 74 44 '/exchange/chatD
00002670: 69 72 65 63 74 45 78 63 68 61 6e 67 65 2f 6d 65 irectExchange/me
00002680: 73 73 61 67 65 73 2d 27 20 2b 20 6d 65 73 73 61 ssages-' + messa
00002690: 67 65 2e 73 65 6e 64 65 72 20 2b 20 27 2d 27 20 ge.sender + '-'
000026a0: 2b 20 6d 65 73 73 61 67 65 2e 72 65 63 69 70 69 + message.recipi
000026b0: 65 6e 74 2c 20 7b 7d 2c 20 4a 53 4f 4e 2e 73 74 ent, {}, JSON.st
000026c0: 72 69 6e 67 69 66 79 28 74 68 61 74 2e 63 6c 65 ringify(that.cle
000026d0: 61 6e 4d 65 73 73 61 67 65 28 6d 65 73 73 61 67 anMessage(messag
000026e0: 65 29 29 29 3b 0d 0a 09 09 09 09 09 2f 2f 20 57 e)));.......// W
000026f0: 65 20 73 65 6e 64 20 61 20 6d 65 73 73 61 67 65 e send a message
00002700: 20 61 67 61 69 6e 20 74 6f 20 6f 75 72 20 71 75 again to our qu
00002710: 65 75 65 20 74 6f 20 73 74 6f 72 65 20 74 68 65 eue to store the
00002720: 20 6e 65 77 20 73 74 61 74 65 20 28 52 45 43 45 new state (RECE
00002730: 49 56 45 44 29 20 6f 66 20 74 68 69 73 20 6d 65 IVED) of this me
00002740: 73 73 61 67 65 0d 0a 09 09 09 09 09 6d 65 73 73 ssage.......mess
00002750: 61 67 65 2e 73 74 61 74 65 3d 22 52 45 43 45 49 age.state="RECEI
00002760: 56 45 44 22 3b 0d 0a 09 09 09 09 09 74 68 61 74 VED";.......that
00002770: 2e 73 74 6f 6d 70 43 6c 69 65 6e 74 44 65 73 74 .stompClientDest
00002780: 69 6e 61 74 69 6f 6e 2e 73 65 6e 64 28 27 2f 65 ination.send('/e
00002790: 78 63 68 61 6e 67 65 2f 63 68 61 74 44 69 72 65 xchange/chatDire
000027a0: 63 74 45 78 63 68 61 6e 67 65 2f 6d 65 73 73 61 ctExchange/messa
000027b0: 67 65 73 2d 27 20 2b 20 6d 65 73 73 61 67 65 2e ges-' + message.
000027c0: 72 65 63 69 70 69 65 6e 74 20 2b 20 27 2d 27 20 recipient + '-'
000027d0: 2b 20 6d 65 73 73 61 67 65 2e 73 65 6e 64 65 72 + message.sender
000027e0: 2c 20 7b 7d 2c 20 4a 53 4f 4e 2e 73 74 72 69 6e , {}, JSON.strin
000027f0: 67 69 66 79 28 74 68 61 74 2e 63 6c 65 61 6e 4d gify(that.cleanM
00002800: 65 73 73 61 67 65 28 6d 65 73 73 61 67 65 29 29 essage(message))
00002810: 29 3b 0d 0a 09 09 09 09 09 2f 2f 20 49 66 20 74 );.......// If t
00002820: 68 65 20 77 69 6e 64 6f 77 20 69 73 20 6f 70 65 he window is ope
00002830: 6e 20 61 6e 64 20 74 68 65 20 62 72 6f 77 73 65 n and the browse
00002840: 72 20 68 61 73 20 74 68 65 20 66 6f 63 75 73 0d r has the focus.
00002850: 0a 09 09 09 09 09 2f 2f 77 69 6e 64 6f 77 2e 61 ......//window.a
00002860: 6c 65 72 74 28 74 68 61 74 2e 69 73 55 73 65 72 lert(that.isUser
00002870: 57 69 6e 64 6f 77 4f 70 65 6e 28 29 20 2b 20 27 WindowOpen() + '
00002880: 61 6e 64 27 20 2b 20 74 68 61 74 2e 24 63 6f 6e and' + that.$con
00002890: 74 61 69 6e 65 72 53 65 74 74 69 6e 67 73 2e 68 tainerSettings.h
000028a0: 61 73 46 6f 63 75 73 29 3b 0d 0a 09 09 09 09 09 asFocus);.......
000028b0: 69 66 20 28 74 68 61 74 2e 69 73 55 73 65 72 57 if (that.isUserW
000028c0: 69 6e 64 6f 77 4f 70 65 6e 28 29 20 26 26 20 74 indowOpen() && t
000028d0: 68 61 74 2e 24 63 6f 6e 74 61 69 6e 65 72 53 65 hat.$containerSe
000028e0: 74 74 69 6e 67 73 2e 68 61 73 46 6f 63 75 73 20 ttings.hasFocus
000028f0: 21 3d 20 66 61 6c 73 65 29 20 7b 0d 0a 09 09 09 != false) {.....
00002900: 09 09 09 6d 65 73 73 61 67 65 2e 73 74 61 74 65 ...message.state
00002910: 3d 22 52 45 41 44 22 3b 0d 0a 09 09 09 09 09 09 ="READ";........
00002920: 2f 2f 20 57 65 20 73 65 6e 64 20 74 68 65 20 6d // We send the m
00002930: 65 73 73 61 67 65 20 61 67 61 69 6e 20 74 6f 20 essage again to
00002940: 74 68 65 20 73 65 6e 64 65 72 20 73 6f 20 74 68 the sender so th
00002950: 61 74 20 69 74 73 20 71 75 65 75 65 20 74 6f 20 at its queue to
00002960: 73 74 6f 72 65 20 74 68 65 20 6e 65 77 20 73 74 store the new st
00002970: 61 74 65 20 28 52 45 41 44 29 20 6f 66 20 74 68 ate (READ) of th
00002980: 69 73 20 6d 65 73 73 61 67 65 2e 0d 0a 09 09 09 is message......
00002990: 09 09 09 74 68 61 74 2e 73 74 6f 6d 70 43 6c 69 ...that.stompCli
000029a0: 65 6e 74 44 65 73 74 69 6e 61 74 69 6f 6e 2e 73 entDestination.s
000029b0: 65 6e 64 28 27 2f 65 78 63 68 61 6e 67 65 2f 63 end('/exchange/c
000029c0: 68 61 74 44 69 72 65 63 74 45 78 63 68 61 6e 67 hatDirectExchang
000029d0: 65 2f 6d 65 73 73 61 67 65 73 2d 27 20 2b 20 6d e/messages-' + m
000029e0: 65 73 73 61 67 65 2e 73 65 6e 64 65 72 20 2b 20 essage.sender +
000029f0: 27 2d 27 20 2b 20 6d 65 73 73 61 67 65 2e 72 65 '-' + message.re
00002a00: 63 69 70 69 65 6e 74 2c 20 7b 7d 2c 20 4a 53 4f cipient, {}, JSO
00002a10: 4e 2e 73 74 72 69 6e 67 69 66 79 28 74 68 61 74 N.stringify(that
00002a20: 2e 63 6c 65 61 6e 4d 65 73 73 61 67 65 28 6d 65 .cleanMessage(me
00002a30: 73 73 61 67 65 29 29 29 3b 0d 0a 09 09 09 09 09 ssage)));.......
00002a40: 7d 0d 0a 09 09 09 09 7d 2c 0d 0a 09 09 09 09 63 }......},......c
00002a50: 6f 6e 66 69 72 6d 52 65 61 64 4d 65 73 73 61 67 onfirmReadMessag
00002a60: 65 3a 20 66 75 6e 63 74 69 6f 6e 20 28 6d 65 73 e: function (mes
00002a70: 73 61 67 65 29 20 7b 0d 0a 09 09 09 09 09 76 61 sage) {.......va
00002a80: 72 20 74 68 61 74 20 3d 20 74 68 69 73 3b 0d 0a r that = this;..
00002a90: 09 09 09 09 09 6d 65 73 73 61 67 65 2e 72 65 63 .....message.rec
00002aa0: 65 69 76 65 64 42 79 43 6c 69 65 6e 74 3d 74 72 eivedByClient=tr
00002ab0: 75 65 3b 0d 0a 09 09 09 09 09 2f 2f 20 57 65 20 ue;.......// We
00002ac0: 73 65 6e 74 20 61 20 6d 65 73 73 61 67 65 20 74 sent a message t
00002ad0: 6f 20 74 68 65 20 73 65 6e 64 65 72 20 69 6e 64 o the sender ind
00002ae0: 69 63 61 74 69 6e 67 20 74 68 61 74 20 77 65 20 icating that we
00002af0: 68 61 76 65 20 72 65 63 65 69 76 65 64 20 69 74 have received it
00002b00: 73 20 6d 65 73 73 61 67 65 20 28 73 6f 20 74 68 s message (so th
00002b10: 61 74 20 74 68 65 20 73 65 6e 64 65 72 20 63 61 at the sender ca
00002b20: 6e 20 6d 61 72 6b 20 64 6f 75 62 6c 65 20 63 68 n mark double ch
00002b30: 65 63 6b 20 69 6e 20 69 74 73 20 75 73 65 72 20 eck in its user
00002b40: 63 68 61 74 20 77 69 6e 64 6f 77 29 0d 0a 09 09 chat window)....
00002b50: 09 09 09 6d 65 73 73 61 67 65 2e 73 74 61 74 65 ...message.state
00002b60: 3d 22 52 45 41 44 22 3b 09 09 09 09 09 09 09 0d ="READ";........
00002b70: 0a 09 09 09 09 09 2f 2f 74 68 61 74 2e 73 74 6f ......//that.sto
00002b80: 6d 70 43 6c 69 65 6e 74 44 65 73 74 69 6e 61 74 mpClientDestinat
00002b90: 69 6f 6e 2e 73 65 6e 64 28 27 2f 65 78 63 68 61 ion.send('/excha
00002ba0: 6e 67 65 2f 63 68 61 74 44 69 72 65 63 74 45 78 nge/chatDirectEx
00002bb0: 63 68 61 6e 67 65 2f 6d 65 73 73 61 67 65 73 2d change/messages-
00002bc0: 27 20 2b 20 6d 65 73 73 61 67 65 2e 73 65 6e 64 ' + message.send
00002bd0: 65 72 20 2b 20 27 2d 6e 6f 74 69 66 69 63 61 74 er + '-notificat
00002be0: 69 6f 6e 27 2c 20 7b 7d 2c 20 64 65 6c 69 76 65 ion', {}, delive
00002bf0: 72 65 64 4d 65 73 73 61 67 65 29 3b 0d 0a 09 09 redMessage);....
00002c00: 09 09 09 2f 2f 20 57 65 20 73 65 6e 64 20 74 68 ...// We send th
00002c10: 65 20 6d 65 73 73 61 67 65 20 61 67 61 69 6e 20 e message again
00002c20: 74 6f 20 74 68 65 20 73 65 6e 64 65 72 20 73 6f to the sender so
00002c30: 20 74 68 61 74 20 69 74 73 20 71 75 65 75 65 20 that its queue
00002c40: 74 6f 20 73 74 6f 72 65 20 74 68 65 20 6e 65 77 to store the new
00002c50: 20 73 74 61 74 65 20 28 44 45 4c 49 56 45 52 45 state (DELIVERE
00002c60: 44 29 20 6f 66 20 74 68 69 73 20 6d 65 73 73 61 D) of this messa
00002c70: 67 65 2e 0d 0a 09 09 09 09 09 74 68 61 74 2e 73 ge........that.s
00002c80: 74 6f 6d 70 43 6c 69 65 6e 74 44 65 73 74 69 6e tompClientDestin
00002c90: 61 74 69 6f 6e 2e 73 65 6e 64 28 27 2f 65 78 63 ation.send('/exc
00002ca0: 68 61 6e 67 65 2f 63 68 61 74 44 69 72 65 63 74 hange/chatDirect
00002cb0: 45 78 63 68 61 6e 67 65 2f 6d 65 73 73 61 67 65 Exchange/message
00002cc0: 73 2d 27 20 2b 20 6d 65 73 73 61 67 65 2e 73 65 s-' + message.se
00002cd0: 6e 64 65 72 20 2b 20 27 2d 27 20 2b 20 6d 65 73 nder + '-' + mes
00002ce0: 73 61 67 65 2e 72 65 63 69 70 69 65 6e 74 2c 20 sage.recipient,
00002cf0: 7b 7d 2c 20 4a 53 4f 4e 2e 73 74 72 69 6e 67 69 {}, JSON.stringi
00002d00: 66 79 28 74 68 61 74 2e 63 6c 65 61 6e 4d 65 73 fy(that.cleanMes
00002d10: 73 61 67 65 28 6d 65 73 73 61 67 65 29 29 29 3b sage(message)));
00002d20: 0d 0a 09 09 09 09 09 2f 2f 20 57 65 20 73 65 6e .......// We sen
00002d30: 64 20 61 20 6d 65 73 73 61 67 65 20 61 67 61 69 d a message agai
00002d40: 6e 20 74 6f 20 6f 75 72 20 71 75 65 75 65 20 74 n to our queue t
00002d50: 6f 20 73 74 6f 72 65 20 74 68 65 20 6e 65 77 20 o store the new
00002d60: 73 74 61 74 65 20 28 52 45 43 45 49 56 45 44 29 state (RECEIVED)
00002d70: 20 6f 66 20 74 68 69 73 20 6d 65 73 73 61 67 65 of this message
00002d80: 09 09 09 09 09 0d 0a 09 09 09 09 09 74 68 61 74 ............that
00002d90: 2e 73 74 6f 6d 70 43 6c 69 65 6e 74 44 65 73 74 .stompClientDest
00002da0: 69 6e 61 74 69 6f 6e 2e 73 65 6e 64 28 27 2f 65 ination.send('/e
00002db0: 78 63 68 61 6e 67 65 2f 63 68 61 74 44 69 72 65 xchange/chatDire
00002dc0: 63 74 45 78 63 68 61 6e 67 65 2f 6d 65 73 73 61 ctExchange/messa
00002dd0: 67 65 73 2d 27 20 2b 20 6d 65 73 73 61 67 65 2e ges-' + message.
00002de0: 72 65 63 69 70 69 65 6e 74 20 2b 20 27 2d 27 20 recipient + '-'
00002df0: 2b 20 6d 65 73 73 61 67 65 2e 73 65 6e 64 65 72 + message.sender
00002e00: 2c 20 7b 7d 2c 20 4a 53 4f 4e 2e 73 74 72 69 6e , {}, JSON.strin
00002e10: 67 69 66 79 28 74 68 61 74 2e 63 6c 65 61 6e 4d gify(that.cleanM
00002e20: 65 73 73 61 67 65 28 6d 65 73 73 61 67 65 29 29 essage(message))
00002e30: 29 3b 09 09 09 09 09 0d 0a 09 09 09 09 7d 2c 0d );...........},.
00002e40: 0a 09 09 09 09 6c 6f 6f 6b 46 6f 72 43 6f 6e 66 .....lookForConf
00002e50: 69 72 6d 69 6e 67 52 65 61 64 4d 65 73 73 61 67 irmingReadMessag
00002e60: 65 73 3a 20 66 75 6e 63 74 69 6f 6e 20 28 29 20 es: function ()
00002e70: 7b 0d 0a 09 09 09 09 09 76 61 72 20 74 68 61 74 {.......var that
00002e80: 20 3d 20 74 68 69 73 3b 0d 0a 09 09 09 09 09 2f = this;......./
00002e90: 2f 76 61 72 20 24 72 65 63 65 69 76 65 64 4d 73 /var $receivedMs
00002ea0: 67 73 20 3d 20 24 28 27 2e 6d 65 73 73 61 67 65 gs = $('.message
00002eb0: 2e 72 65 63 65 69 76 65 64 2d 6d 65 73 73 61 67 .received-messag
00002ec0: 65 20 73 70 61 6e 3a 64 61 74 61 28 6d 65 73 73 e span:data(mess
00002ed0: 61 67 65 49 64 29 27 2c 20 74 68 61 74 2e 24 75 ageId)', that.$u
00002ee0: 73 65 72 57 69 6e 64 6f 77 29 2e 66 69 6c 74 65 serWindow).filte
00002ef0: 72 28 66 75 6e 63 74 69 6f 6e 20 28 29 20 7b 72 r(function () {r
00002f00: 65 74 75 72 6e 20 24 28 74 68 69 73 29 2e 64 61 eturn $(this).da
00002f10: 74 61 28 27 73 74 61 74 65 27 29 20 3d 3d 3d 20 ta('state') ===
00002f20: 27 52 45 43 45 49 56 45 44 27 7d 29 3b 0d 0a 09 'RECEIVED'});...
00002f30: 09 09 09 09 2f 2f 20 57 65 20 72 65 74 72 69 76 ....// We retriv
00002f40: 65 64 20 74 68 65 20 52 45 43 45 49 56 45 44 20 ed the RECEIVED
00002f50: 6d 65 73 73 61 67 65 73 20 66 72 6f 6d 20 6f 75 messages from ou
00002f60: 72 20 71 75 65 75 65 0d 0a 09 09 09 09 09 76 61 r queue.......va
00002f70: 72 20 72 65 63 65 69 76 65 64 4d 65 73 73 61 67 r receivedMessag
00002f80: 65 73 20 3d 20 24 2e 67 72 65 70 28 74 68 61 74 es = $.grep(that
00002f90: 2e 71 75 65 75 65 4d 65 73 73 61 67 65 73 2c 20 .queueMessages,
00002fa0: 66 75 6e 63 74 69 6f 6e 20 28 61 29 20 7b 20 72 function (a) { r
00002fb0: 65 74 75 72 6e 20 61 2e 73 74 61 74 65 20 3d 3d eturn a.state ==
00002fc0: 3d 20 27 52 45 43 45 49 56 45 44 27 3b 20 7d 29 = 'RECEIVED'; })
00002fd0: 3b 0d 0a 09 09 09 09 09 2f 2f 24 64 65 6c 69 76 ;.......//$deliv
00002fe0: 65 72 65 64 50 2e 69 6e 64 65 78 28 22 5b 64 61 eredP.index("[da
00002ff0: 74 61 2d 73 74 61 74 65 3d 27 52 45 43 45 49 56 ta-state='RECEIV
00003000: 45 44 27 5d 22 29 20 74 68 69 73 20 64 6f 65 73 ED']") this does
00003010: 6e 27 74 20 77 6f 72 6b 2c 20 49 20 6e 65 65 64 n't work, I need
00003020: 20 74 6f 20 74 72 69 65 64 20 69 6e 63 72 65 61 to tried increa
00003030: 73 69 6e 67 20 74 68 65 20 76 65 72 73 69 6f 6e sing the version
00003040: 20 6f 66 20 6a 71 75 65 72 79 0d 0a 09 09 09 09 of jquery......
00003050: 09 2f 2f 76 61 72 20 24 72 65 63 65 69 76 65 64 .//var $received
00003060: 50 20 3d 20 24 72 65 63 65 69 76 65 64 4d 73 67 P = $receivedMsg
00003070: 73 2e 66 69 6c 74 65 72 28 66 75 6e 63 74 69 6f s.filter(functio
00003080: 6e 20 28 29 20 7b 72 65 74 75 72 6e 20 24 28 74 n () {return $(t
00003090: 68 69 73 29 2e 64 61 74 61 28 27 73 74 61 74 65 his).data('state
000030a0: 27 29 20 3d 3d 3d 20 27 52 45 43 45 49 56 45 44 ') === 'RECEIVED
000030b0: 27 7d 29 3b 09 09 09 09 09 0d 0a 09 09 09 09 09 '});............
000030c0: 24 2e 65 61 63 68 28 72 65 63 65 69 76 65 64 4d $.each(receivedM
000030d0: 65 73 73 61 67 65 73 2c 20 66 75 6e 63 74 69 6f essages, functio
000030e0: 6e 20 28 69 6e 64 65 78 2c 20 6d 65 73 73 61 67 n (index, messag
000030f0: 65 29 20 7b 0d 0a 09 09 09 09 09 09 2f 2f 20 57 e) {........// W
00003100: 65 20 6c 6f 6f 6b 20 66 6f 72 20 61 20 6d 65 73 e look for a mes
00003110: 73 61 67 65 20 52 45 41 44 20 62 79 20 74 68 65 sage READ by the
00003120: 20 73 61 6d 65 20 69 64 20 69 6e 20 6f 75 72 20 same id in our
00003130: 62 72 6f 77 73 65 72 20 73 74 6f 72 65 64 20 6d browser stored m
00003140: 65 73 73 61 67 65 73 0d 0a 09 09 09 09 09 09 2f essages......../
00003150: 2f 20 72 65 70 6c 61 63 65 20 67 72 65 70 20 62 / replace grep b
00003160: 79 20 66 69 6e 64 4f 6e 65 20 6f 72 20 66 69 6e y findOne or fin
00003170: 64 20 66 72 6f 6d 20 75 6e 64 65 72 73 63 6f 72 d from underscor
00003180: 65 20 74 6f 20 67 65 74 20 6f 6e 6c 79 20 6f 6e e to get only on
00003190: 65 20 65 6c 65 6d 65 6e 74 20 61 6e 64 20 6e 6f e element and no
000031a0: 74 20 6c 6f 6f 70 69 6e 67 20 61 6c 6c 20 74 68 t looping all th
000031b0: 65 20 6d 65 73 73 61 67 65 73 20 65 6c 73 65 20 e messages else
000031c0: 73 74 6f 70 69 6e 67 0d 0a 09 09 09 09 09 09 2f stoping......../
000031d0: 2f 20 77 68 65 6e 20 74 68 65 20 66 69 72 73 74 / when the first
000031e0: 20 6d 65 73 73 61 67 65 20 69 73 20 66 6f 75 6e message is foun
000031f0: 64 0d 0a 09 09 09 09 09 09 76 61 72 20 72 65 61 d........var rea
00003200: 64 4d 65 73 73 61 67 65 20 3d 20 5f 2e 66 69 6e dMessage = _.fin
00003210: 64 28 74 68 61 74 2e 71 75 65 75 65 4d 65 73 73 d(that.queueMess
00003220: 61 67 65 73 2c 20 66 75 6e 63 74 69 6f 6e 20 28 ages, function (
00003230: 61 29 20 7b 20 72 65 74 75 72 6e 20 61 2e 69 64 a) { return a.id
00003240: 20 3d 3d 3d 20 6d 65 73 73 61 67 65 2e 69 64 20 === message.id
00003250: 26 26 20 61 2e 73 74 61 74 65 20 3d 3d 3d 20 27 && a.state === '
00003260: 52 45 41 44 27 3b 20 7d 29 3b 0d 0a 09 09 09 09 READ'; });......
00003270: 09 09 69 66 20 28 21 72 65 61 64 4d 65 73 73 61 ..if (!readMessa
00003280: 67 65 29 20 7b 0d 0a 09 09 09 09 09 09 09 74 68 ge) {.........th
00003290: 61 74 2e 63 6f 6e 66 69 72 6d 52 65 61 64 4d 65 at.confirmReadMe
000032a0: 73 73 61 67 65 28 6d 65 73 73 61 67 65 29 3b 0d ssage(message);.
000032b0: 0a 09 09 09 09 09 09 7d 09 0d 0a 09 09 09 09 09 .......}........
000032c0: 7d 29 3b 0d 0a 09 09 09 09 7d 2c 0d 0a 09 09 09 });......},.....
000032d0: 09 69 73 55 73 65 72 57 69 6e 64 6f 77 4f 70 65 .isUserWindowOpe
000032e0: 6e 3a 20 66 75 6e 63 74 69 6f 6e 20 28 29 20 7b n: function () {
000032f0: 0d 0a 09 09 09 09 09 72 65 74 75 72 6e 20 74 68 .......return th
00003300: 69 73 2e 6f 70 74 69 6f 6e 73 2e 68 61 73 4c 6f is.options.hasLo
00003310: 61 64 65 64 20 26 26 20 74 68 69 73 2e 24 75 73 aded && this.$us
00003320: 65 72 57 69 6e 64 6f 77 2e 64 69 61 6c 6f 67 28 erWindow.dialog(
00003330: 27 69 73 4f 70 65 6e 27 29 3b 0d 0a 09 09 09 09 'isOpen');......
00003340: 7d 0d 0a 09 09 7d 0d 0a 09 7d 0d 0a 09 0d 0a 7d }....}...}.....}
00003350: 29 28 6a 51 75 65 72 79 29 3b )(jQuery);